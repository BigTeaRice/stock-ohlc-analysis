# ------------------------------
# GitHub Actions å·¥ä½œæµç¨‹ï¼šè…¾è®¯è‚¡ç¥¨Kçº¿å›¾ç”Ÿæˆä¸æ¨é€
# åŠŸèƒ½ï¼šå®šæ—¶/æ‰‹åŠ¨è§¦å‘æ•°æ®æ›´æ–°ã€ç”ŸæˆKçº¿å›¾ã€ä¸Šä¼ å·¥ä»¶å¹¶é€šçŸ¥
# ------------------------------
name: Tencent Stock OHLC Pipeline

# ------------------------------
# è§¦å‘æ¡ä»¶é…ç½®
# ------------------------------
on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè°ƒè¯•æ¨¡å¼è¾“å…¥ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰'
        required: false
        default: false
        type: boolean
  
  # 2. è‡ªåŠ¨è°ƒåº¦ï¼šé¦™æ¸¯æ—¶é—´æ¯æ™š10ç‚¹ï¼ˆUTC 14:00ï¼Œå‘¨ä¸€è‡³å‘¨äº”ï¼‰
  schedule:
    - cron: '0 14 * * 1-5'
  
  # 3. ä»£ç å˜åŠ¨è§¦å‘ï¼ˆpush/PRåˆ°mainåˆ†æ”¯ï¼‰
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ------------------------------
# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆé›†ä¸­ç®¡ç†é…ç½®ï¼‰
# ------------------------------
env:
  PYTHON_VERSION: '3.10'                  # Pythonç‰ˆæœ¬
  TICKER: '0700.HK'                       # è‚¡ç¥¨ä»£ç ï¼ˆè…¾è®¯æ¸¯è‚¡ï¼‰
  CACHE_DIR: 'stock_data'                 # æ•°æ®ç¼“å­˜ç›®å½•
  HTML_OUTPUT: 'ohlc_chart.html'          # ç”Ÿæˆçš„Kçº¿å›¾è·¯å¾„
  CSV_OUTPUT: '0700-HK.csv'               # ç¼“å­˜çš„CSVæ•°æ®è·¯å¾„
  WORKFLOW_PREFIX: 'tencent-${{ env.TICKER }}'  # å·¥ä»¶å‰ç¼€ï¼ˆç»Ÿä¸€å‘½åï¼‰
  LOG_RETENTION: 3                        # æ—¥å¿—ä¿ç•™å¤©æ•°
  ARTIFACT_RETENTION: 7                   # å…¶ä»–å·¥ä»¶ä¿ç•™å¤©æ•°


# ------------------------------
# æ ¸å¿ƒä½œä¸šï¼šç”ŸæˆKçº¿å›¾ä¸æ•°æ®å¤„ç†
# ------------------------------
jobs:
  generate-chart:
    name: Generate OHLC Chart & Data
    runs-on: ubuntu-latest
    timeout-minutes: 20                     # ä½œä¸šè¶…æ—¶æ—¶é—´
    outputs:
      script_status: ${{ steps.run_script.outputs.status }}  # è„šæœ¬æ‰§è¡ŒçŠ¶æ€
      html_exists: ${{ steps.verify.outputs.html_exists }}    # HTMLæ˜¯å¦å­˜åœ¨
      csv_exists: ${{ steps.verify.outputs.csv_exists }}      # CSVæ˜¯å¦å­˜åœ¨

    steps:
      # 1. æ£€å‡ºä»“åº“å®Œæ•´ä»£ç ï¼ˆç¡®ä¿è·å–æ‰€æœ‰æ–‡ä»¶ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                      # æ‹‰å–å®Œæ•´å†å²ï¼ˆé¿å…ç¼“å­˜é—®é¢˜ï¼‰

      # 2. è®¾ç½®Pythonç¯å¢ƒï¼ˆç¼“å­˜pipä¾èµ–åŠ é€Ÿï¼‰
      - name: Set Up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'                        # ç¼“å­˜pipåŒ…
          cache-dependency-path: 'requirements.txt'  # ä¾èµ–æ¸…å•è·¯å¾„ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼‰

      # 3. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip  # å‡çº§pip
          pip install pandas plotly yfinance pytz  # å®‰è£…æ ¸å¿ƒä¾èµ–
          echo "[INFO] ä¾èµ–å®‰è£…å®Œæˆ"

      # 4. åˆ›å»ºæ•°æ®ç¼“å­˜ç›®å½•
      - name: Create Cache Directory
        run: |
          mkdir -p ${{ env.CACHE_DIR }}
          echo "[INFO] ç¼“å­˜ç›®å½•å·²åˆ›å»ºï¼š${{ env.CACHE_DIR }}"

      # 5. è¿è¡Œä¸»è„šæœ¬ï¼ˆä¼ é€’è°ƒè¯•æ¨¡å¼å‚æ•°ï¼‰
      - name: Execute Chart Generation Script
        id: run_script
        run: |
          echo "[INFO] å¯åŠ¨æ•°æ®è·å–ä¸å›¾è¡¨ç”Ÿæˆ..."
          python main.py --debug-mode ${{ inputs.debug_mode }}  # ä¼ é€’æ‰‹åŠ¨è§¦å‘çš„è°ƒè¯•å‚æ•°
          exit_code=$?
          echo "script_exit_code=$exit_code" >> $GITHUB_OUTPUT  # è¾“å‡ºé€€å‡ºç åˆ°ä¸Šä¸‹æ–‡
          if [ $exit_code -eq 0 ]; then
            echo "[SUCCESS] è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            echo "script_status=success" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ˆé”™è¯¯ç ï¼š$exit_codeï¼‰"
            echo "script_status=failure" >> $GITHUB_OUTPUT
          fi

      # 6. éªŒè¯è¾“å‡ºæ–‡ä»¶å®Œæ•´æ€§
      - name: Verify Output Files
        id: verify
        run: |
          echo "[INFO] å¼€å§‹éªŒè¯è¾“å‡ºæ–‡ä»¶..."
          # éªŒè¯HTMLå›¾è¡¨
          if [[ -f "${{ env.HTML_OUTPUT }}" ]]; then
            html_size=$(du -h "${{ env.HTML_OUTPUT }}" | cut -f1)
            echo "[SUCCESS] HTMLå›¾è¡¨å·²ç”Ÿæˆ - å¤§å°ï¼š$html_size"
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] HTMLå›¾è¡¨æœªæ‰¾åˆ°ï¼š${{ env.HTML_OUTPUT }}"
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi
          # éªŒè¯CSVæ•°æ®
          csv_full_path="${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}"
          if [[ -f "$csv_full_path" ]]; then
            csv_size=$(du -h "$csv_full_path" | cut -f1)
            echo "[SUCCESS] CSVæ•°æ®å·²ç¼“å­˜ - å¤§å°ï¼š$csv_size"
            echo "csv_exists=true" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] CSVæ•°æ®æœªæ‰¾åˆ°ï¼š$csv_full_path"
            echo "csv_exists=false" >> $GITHUB_OUTPUT
          fi
          # è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºç›®å½•è¯¦æƒ…
          if ${{ inputs.debug_mode }}; then
            echo "[DEBUG] æ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la .
            echo "[DEBUG] ç¼“å­˜ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la ${{ env.CACHE_DIR }}
          fi

      # 7. ä¸Šä¼ HTMLå›¾è¡¨ï¼ˆä»…å½“è„šæœ¬æˆåŠŸä¸”æ–‡ä»¶å­˜åœ¨æ—¶ï¼‰
      - name: Upload HTML Artifact
        if: steps.run_script.outputs.script_status == 'success' && steps.verify.outputs.html_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-chart
          path: ${{ env.HTML_OUTPUT }}
          retention-days: ${{ env.ARTIFACT_RETENTION }}
          compression-level: 0                  # ä¸å‹ç¼©ï¼ˆä¿æŒHTMLå¯è¯»ï¼‰

      # 8. ä¸Šä¼ CSVæ•°æ®ï¼ˆä»…å½“æ–‡ä»¶å­˜åœ¨æ—¶ï¼‰
      - name: Upload CSV Data Artifact
        if: steps.verify.outputs.csv_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-data
          path: ${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}
          retention-days: ${{ env.ARTIFACT_RETENTION }}

      # 9. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ ï¼‰
      - name: Upload Log Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-logs
          path: |
            *.log                              # æ ¹ç›®å½•æ—¥å¿—
            ${{ env.CACHE_DIR }}/*.log         # ç¼“å­˜ç›®å½•æ—¥å¿—
          retention-days: ${{ env.LOG_RETENTION }}
          if-no-files-found: ignore             # æ— æ—¥å¿—æ—¶ä¸æŠ¥é”™

      # 10. å‘é€æ‰§è¡Œç»“æœé€šçŸ¥ï¼ˆç¤ºä¾‹ï¼šEchoï¼Œå¯æ›¿æ¢ä¸ºSlack/Emailï¼‰
      - name: Send Notification
        run: |
          case "${{ steps.run_script.outputs.script_status }}" in
            "success")
              if ${{ steps.verify.outputs.html_exists }} == "true"; then
                echo "ğŸ‰ ä½œä¸šæˆåŠŸï¼HTMLå›¾è¡¨å·²ç”Ÿæˆï¼š${{ env.HTML_OUTPUT }}"
                echo "ğŸ“Š è®¿é—®å·¥ä»¶ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              else
                echo "âš ï¸ è„šæœ¬æˆåŠŸä½†æœªç”Ÿæˆå›¾è¡¨ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼š${{ env.WORKFLOW_PREFIX }}-logs"
              fi
              ;;
            "failure")
              echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼è¯·æŸ¥çœ‹æ—¥å¿—ï¼š${{ env.WORKFLOW_PREFIX }}-logs"
              ;;
          esac


# ------------------------------
# å¯é€‰ä½œä¸šï¼šéªŒè¯å·¥ä»¶å®Œæ•´æ€§ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
# ------------------------------
test-artifacts:
  name: Test Generated Artifacts
  runs-on: ubuntu-latest
  needs: generate-chart                     # ä¾èµ–generate-chartä½œä¸š
  if: always()                              # æ— è®ºä¸Šæ¸¸æˆåŠŸå¤±è´¥éƒ½è¿è¡Œ
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-results                    # ä¸‹è½½çš„å·¥ä»¶å­˜æ”¾è·¯å¾„

    - name: Verify Artifact Integrity
      run: |
        echo "[INFO] ä¸‹è½½çš„å·¥ä»¶åˆ—è¡¨ï¼š"
        ls -la test-results
        echo "[SUCCESS] å·¥ä»¶å®Œæ•´æ€§éªŒè¯å®Œæˆ"
