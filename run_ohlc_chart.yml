# ------------------------------
# GitHub Actions å·¥ä½œæµç¨‹ï¼šè‚¡ç¥¨æ•°æ®åˆ†æ
# ------------------------------
name: Stock Data Analysis Pipeline  # å·¥ä½œæµç¨‹åç§°ï¼ˆè‡ªå®šä¹‰ï¼‰

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»£ç åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
on:
  push:
    branches: [ "main" ]

# å®šä¹‰ä½œæ¥­ï¼šåœ¨ Ubuntu æœ€æ–°ç¯å¢ƒä¸­è¿è¡Œ
jobs:
  analyze-and-upload:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu ç³»ç»Ÿ

    steps:
      # ------------------------------
      # æ­¥éª¤1ï¼šæª¢å‡ºå€‰åº«ä»£ç¢¼ï¼ˆå¿…é ˆï¼‰
      # ------------------------------
      - name: Checkout Repository Code
        uses: actions/checkout@v4  # æœ€æ–°ç‰ˆä»£ç æ£€å‡ºåŠ¨ä½œ
        with:
          fetch-depth: 0  # æ£€å‡ºå®Œæ•´å†å²ï¼ˆç¡®ä¿èƒ½è·å–æ‰€æœ‰æ–‡ä»¶ï¼‰

      # ------------------------------
      # æ­¥éª¤2ï¼šè®¾ç½® Python ç¯å¢ƒ
      # ------------------------------
      - name: Set Up Python Environment
        uses: actions/setup-python@v5  # æœ€æ–°ç‰ˆ Python ç¯å¢ƒé…ç½®
        with:
          python-version: "3.11"  # ä¸æœ¬åœ° Python ç‰ˆæœ¬ä¸€è‡´ï¼ˆå¯æ¢ä¸º 3.10/3.9ï¼‰

      # ------------------------------
      # æ­¥éª¤3ï¼šå®‰è£…é¡¹ç›®ä¾èµ–
      # ------------------------------
      - name: Install Dependencies
        run: |name: Generate Tencent Stock Chart

on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè°ƒè¯•æ¨¡å¼ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰'
        required: false
        default: false
        type: boolean
  
  # 2. è‡ªåŠ¨è°ƒåº¦ï¼šé¦™æ¸¯æ—¶é—´æ¯æ™š10ç‚¹ï¼ˆUTC 14:00ï¼‰
  schedule:
    - cron: '0 14 * * 1-5'  # å‘¨ä¸€è‡³å‘¨äº”æ™š10ç‚¹ï¼ˆé¦™æ¸¯æ—¶é—´ï¼‰
  
  # 3. ä»£ç æ¨é€/PRè§¦å‘
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'
  TICKER: '0700.HK'
  CACHE_DIR: 'stock_data'
  HTML_OUTPUT: 'ohlc_chart.html'
  CSV_OUTPUT: '0700-HK.csv'
  WORKFLOW_ARTIFACT_PREFIX: 'tencent-${{ env.TICKER }}'


jobs:
  generate-chart:
    name: Generate OHLC Chart
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.generate.outputs.status }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4  # æœ€æ–°ç‰ˆæœ¬
        with:
          fetch-depth: 0

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set Up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5  # æœ€æ–°ç‰ˆæœ¬
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas plotly yfinance pytz
          echo "[INFO] ä¾èµ–å®‰è£…å®Œæˆ"

      # 4. åˆ›å»ºç¼“å­˜ç›®å½•
      - name: Create Cache Directory
        run: |
          mkdir -p ${{ env.CACHE_DIR }}
          echo "[INFO] ç¼“å­˜ç›®å½•ï¼š${{ env.CACHE_DIR }}"

      # 5. è¿è¡Œè„šæœ¬ï¼ˆä¼ é€’debugå‚æ•°ï¼‰
      - name: Run Chart Generation Script
        id: generate
        run: |
          echo "[INFO] å¯åŠ¨è„šæœ¬..."
          python main.py --debug_mode ${{ inputs.debug_mode }}
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then
            echo "[SUCCESS] è„šæœ¬æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] è„šæœ¬å¤±è´¥ï¼ˆç ï¼š$exit_codeï¼‰"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # 6. éªŒè¯æ–‡ä»¶
      - name: Verify Generated Files
        id: verify
        run: |
          echo "[INFO] éªŒè¯è¾“å‡º..."
          # æ£€æŸ¥HTML
          if [ -f "${{ env.HTML_OUTPUT }}" ]; then
            html_size=$(du -h "${{ env.HTML_OUTPUT }}" | cut -f1)
            echo "[SUCCESS] HTMLå­˜åœ¨ - å¤§å°ï¼š$html_size"
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] HTMLæœªæ‰¾åˆ°ï¼š${{ env.HTML_OUTPUT }}"
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi
          # æ£€æŸ¥CSV
          csv_path="${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}"
          if [ -f "$csv_path" ]; then
            csv_size=$(du -h "$csv_path" | cut -f1)
            echo "[SUCCESS] CSVå­˜åœ¨ - å¤§å°ï¼š$csv_size"
            echo "csv_exists=true" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] CSVæœªæ‰¾åˆ°ï¼š$csv_path"
            echo "csv_exists=false" >> $GITHUB_OUTPUT
          fi
          # è°ƒè¯•æ¨¡å¼è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
          if ${{ inputs.debug_mode }}; then
            echo "[DEBUG] æ ¹ç›®å½•æ–‡ä»¶ï¼š"
            ls -la .
            echo "[DEBUG] ç¼“å­˜ç›®å½•æ–‡ä»¶ï¼š"
            ls -la ${{ env.CACHE_DIR }}
          fi

      # 7. ä¸Šä¼ HTMLå›¾è¡¨ï¼ˆä»…æˆåŠŸæ—¶ï¼‰
      - name: Upload HTML Artifact
        if: steps.verify.outputs.html_exists == 'true'
        uses: actions/upload-artifact@v4  # å…³é”®ä¿®æ­£ï¼šå‡çº§åˆ°v4
        with:
          name: ${{ env.WORKFLOW_ARTIFACT_PREFIX }}-chart
          path: ${{ env.HTML_OUTPUT }}
          retention-days: 7
          compression-level: 0

      # 8. ä¸Šä¼ CSVæ•°æ®ï¼ˆä»…æˆåŠŸæ—¶ï¼‰
      - name: Upload CSV Artifact
        if: steps.verify.outputs.csv_exists == 'true'
        uses: actions/upload-artifact@v4  # å…³é”®ä¿®æ­£ï¼šå‡çº§åˆ°v4
        with:
          name: ${{ env.WORKFLOW_ARTIFACT_PREFIX }}-data
          path: ${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}
          retention-days: 7
          compression-level: 0

      # 9. ä¸Šä¼ æ—¥å¿—
      - name: Upload Log Files
        uses: actions/upload-artifact@v4  # å…³é”®ä¿®æ­£ï¼šå‡çº§åˆ°v4
        with:
          name: ${{ env.WORKFLOW_ARTIFACT_PREFIX }}-logs
          path: |
            *.log
            ${{ env.CACHE_DIR }}/*.log
          retention-days: 3
          if-no-files-found: ignore

      # 10. å‘é€é€šçŸ¥
      - name: Success Notification
        if: success() && steps.verify.outputs.html_exists == 'true'
        run: |
          echo "ğŸ‰ æˆåŠŸï¼"
          echo "ğŸ“Š è®¿é—®å·¥ä»¶ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“ æ–‡ä»¶ï¼š${{ env.HTML_OUTPUT }}ã€${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}"

      - name: Partial Success Notification
        if: success() && steps.verify.outputs.html_exists != 'true'
        run: |
          echo "âš ï¸ è„šæœ¬è¿è¡Œä½†æœªç”Ÿæˆå›¾è¡¨"
          echo "ğŸ” æ£€æŸ¥æ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Failure Notification
        if: failure()
        run: |
          echo "âŒ å¤±è´¥ï¼"
          echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ env.WORKFLOW_ARTIFACT_PREFIX }}-logs"


  # æµ‹è¯•ä»»åŠ¡ï¼ˆéªŒè¯å·¥ä»¶ï¼‰
  test-artifacts:
    name: Test Generated Artifacts
    runs-on: ubuntu-latest
    needs: generate-chart
    if: always()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4  # æœ€æ–°ç‰ˆæœ¬
        with:
          path: test-results

      - name: Verify Artifacts
        run: |
          echo "[INFO] ä¸‹è½½çš„å·¥ä»¶ï¼š"
          ls -la test-results
          echo "[SUCCESS] å·¥ä»¶éªŒè¯å®Œæˆ"
