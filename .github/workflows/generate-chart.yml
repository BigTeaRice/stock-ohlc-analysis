name: Generate Tencent Stock Chart

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean
  
  # è‡ªå‹•èª¿åº¦ - æ¯å€‹å·¥ä½œæ—¥é¦™æ¸¯æ™‚é–“æ™šä¸Š10é»é‹è¡Œ (UTC+8)
  schedule:
    - cron: '0 14 * * 1-5'  # UTCæ™‚é–“14:00 = é¦™æ¸¯æ™‚é–“22:00
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches: [ main ]
  
  # å‰µå»ºPull Requestæ™‚è§¸ç™¼
  pull_request:
    branches: [ main ]

# è¨­ç½®ç’°å¢ƒè®Šé‡
env:
  PYTHON_VERSION: '3.10'
  TICKER: '0700.HK'
  CACHE_DIR: 'stock_data'

jobs:
  generate-chart:
    name: Generate OHLC Chart
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæª¢å‡ºä»£ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ç¬¬äºŒæ­¥ï¼šè¨­ç½®Pythonç’°å¢ƒ
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£ä¾è³´
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas plotly yfinance
          echo "Dependencies installed successfully"

      # ç¬¬å››æ­¥ï¼šå‰µå»ºæ•¸æ“šç›®éŒ„
      - name: Create data directory
        run: |
          mkdir -p ${{ env.CACHE_DIR }}
          echo "Directory created: ${{ env.CACHE_DIR }}"

      # ç¬¬äº”æ­¥ï¼šé‹è¡ŒPythonè…³æœ¬
      - name: Run chart generation script
        id: generate
        run: |
          echo "Starting chart generation for ${{ env.TICKER }}..."
          python main.py
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true  # å³ä½¿è…³æœ¬å¤±æ•—ä¹Ÿç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ­¥é©Ÿ

      # ç¬¬å…­æ­¥ï¼šæª¢æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      - name: Verify generated files
        id: verify
        run: |
          echo "Checking generated files in ${{ env.CACHE_DIR }}..."
          
          # æª¢æŸ¥HTMLæ–‡ä»¶
          if [ -f "${{ env.CACHE_DIR }}/0700_HK_candlestick.html" ]; then
            html_size=$(du -h "${{ env.CACHE_DIR }}/0700_HK_candlestick.html" | cut -f1)
            echo "HTML file exists - Size: $html_size"
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "HTML file does not exist"
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # æª¢æŸ¥CSVæ–‡ä»¶
          if [ -f "${{ env.CACHE_DIR }}/0700_HK.csv" ]; then
            csv_size=$(du -h "${{ env.CACHE_DIR }}/0700_HK.csv" | cut -f1)
            echo "CSV file exists - Size: $csv_size"
            echo "csv_exists=true" >> $GITHUB_OUTPUT
          else
            echo "CSV file does not exist"
            echo "csv_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "All files in directory:"
          ls -la ${{ env.CACHE_DIR }}/

      # ç¬¬ä¸ƒæ­¥ï¼šä¸Šå‚³HTMLåœ–è¡¨
      - name: Upload HTML chart artifact
        if: steps.verify.outputs.html_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tencent-ohlc-chart
          path: ${{ env.CACHE_DIR }}/0700_HK_candlestick.html
          retention-days: 7
          compression-level: 0

      # ç¬¬å…«æ­¥ï¼šä¸Šå‚³CSVæ•¸æ“š
      - name: Upload CSV data artifact
        if: steps.verify.outputs.csv_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tencent-stock-data
          path: ${{ env.CACHE_DIR }}/0700_HK.csv
          retention-days: 7
          compression-level: 0

      # ç¬¬ä¹æ­¥ï¼šä¸Šå‚³æ—¥èªŒæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Upload log files
        uses: actions/upload-artifact@v4
        with:
          name: generation-logs
          path: |
            *.log
            ${{ env.CACHE_DIR }}/*.log
          retention-days: 3
          if-no-files-found: ignore

      # ç¬¬åæ­¥ï¼šä¸Šå‚³æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ä½œç‚ºå‚™ä»½
      - name: Upload all generated files
        uses: actions/upload-artifact@v4
        with:
          name: all-generated-files
          path: ${{ env.CACHE_DIR }}/
          retention-days: 3
          if-no-files-found: ignore

      # ç¬¬åä¸€æ­¥ï¼šç™¼é€æˆåŠŸé€šçŸ¥
      - name: Success notification
        if: success() && steps.verify.outputs.html_exists == 'true'
        run: |
          echo "âœ… Chart generation completed successfully!"
          echo "ğŸ“Š Chart and data artifacts have been uploaded"
          echo "ğŸ“ˆ Ticker: ${{ env.TICKER }}"
          echo "ğŸ“ Files available in the Artifacts section"

      # ç¬¬åäºŒæ­¥ï¼šç™¼é€è­¦å‘Šé€šçŸ¥ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰
      - name: Partial success notification
        if: success() && steps.verify.outputs.html_exists != 'true'
        run: |
          echo "âš ï¸ Workflow completed but no chart was generated"
          echo "ğŸ“ Other artifacts may be available for debugging"

      # ç¬¬åä¸‰æ­¥ï¼šç™¼é€å¤±æ•—é€šçŸ¥
      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ Workflow failed!"
          echo "Please check the logs for detailed error information"
          echo "Artifacts may contain debug information"

  # å¯é¸ï¼šæ·»åŠ ä¸€å€‹æ¸¬è©¦ä»»å‹™
  test-generation:
    name: Test Generation
    runs-on: ubuntu-latest
    needs: generate-chart
    if: always()  # å³ä½¿ä¸»ä»»å‹™å¤±æ•—ä¹Ÿé‹è¡Œ
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download artifacts for testing
        uses: actions/download-artifact@v4
        with:
          name: all-generated-files
          path: test-artifacts
          
      - name: Test artifact existence
        run: |
          echo "Testing downloaded artifacts..."
          if [ -d "test-artifacts" ]; then
            echo "Artifacts downloaded successfully"
            ls -la test-artifacts/
          else
            echo "No artifacts found for testing"
          fi

# å·¥ä½œæµç¨‹ç´šåˆ¥çš„é…ç½®
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
