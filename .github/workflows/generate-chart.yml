name: Generate Tencent Stock Chart

on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè°ƒè¯•æ¨¡å¼ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰'
        required: false
        default: false
        type: boolean
  
  # 2. è‡ªåŠ¨è°ƒåº¦ï¼šé¦™æ¸¯æ—¶é—´æ¯æ™š10ç‚¹ï¼ˆUTC 14:00ï¼‰
  schedule:
    - cron: '0 14 * * 1-5'  # å‘¨ä¸€è‡³å‘¨äº”æ™š10ç‚¹ï¼ˆé¦™æ¸¯æ—¶é—´ï¼‰
  
  # 3. ä»£ç æ¨é€/PRè§¦å‘
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆä¸Pythonè„šæœ¬è§£è€¦ï¼‰
env:
  PYTHON_VERSION: '3.10'
  TICKER: '0700.HK'               # æ¸¯è‚¡ä»£ç 
  CACHE_DIR: 'stock_data'         # æ•°æ®ç¼“å­˜ç›®å½•ï¼ˆä¸è„šæœ¬ä¸€è‡´ï¼‰
  HTML_OUTPUT: 'ohlc_chart.html'  # å›¾è¡¨è¾“å‡ºæ–‡ä»¶åï¼ˆæ ¹ç›®å½•ï¼‰
  CSV_OUTPUT: '0700-HK.csv'       # ç¼“å­˜CSVæ–‡ä»¶åï¼ˆTICKERæ›¿æ¢.ä¸º-ï¼‰
  WORKFLOW_ARTIFACT_PREFIX: 'tencent-${{ env.TICKER }}'  # å·¥ä»¶å‰ç¼€ï¼ˆç»Ÿä¸€å‘½åï¼‰


jobs:
  generate-chart:
    name: Generate OHLC Chart
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.generate.outputs.status }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set Up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas plotly yfinance pytz
          echo "[INFO] ä¾èµ–å®‰è£…å®Œæˆ"

      # 4. åˆ›å»ºç¼“å­˜ç›®å½•
      - name: Create Cache Directory
        run: |
          mkdir -p ${{ env.CACHE_DIR }}
          echo "[INFO] ç¼“å­˜ç›®å½•åˆ›å»ºï¼š${{ env.CACHE_DIR }}"

      # 5. è¿è¡Œè„šæœ¬ï¼ˆä¼ é€’debug_modeå‚æ•°ï¼‰
      - name: Run Chart Generation Script
        id: generate
        run: |
          echo "[INFO] å¯åŠ¨å›¾è¡¨ç”Ÿæˆè„šæœ¬..."
          python main.py --debug_mode ${{ inputs.debug_mode }}
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then
            echo "[SUCCESS] è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç ï¼š$exit_codeï¼‰"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­åç»­æ­¥éª¤ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

      # 6. éªŒè¯ç”Ÿæˆæ–‡ä»¶
      - name: Verify Generated Files
        id: verify
        run: |
          echo "[INFO] éªŒè¯è¾“å‡ºæ–‡ä»¶..."
          
          # éªŒè¯HTMLå›¾è¡¨ï¼ˆæ ¹ç›®å½•ï¼‰
          if [ -f "${{ env.HTML_OUTPUT }}" ]; then
            html_size=$(du -h "${{ env.HTML_OUTPUT }}" | cut -f1)
            echo "[SUCCESS] HTMLå›¾è¡¨å­˜åœ¨ - å¤§å°ï¼š$html_size"
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] HTMLå›¾è¡¨æœªæ‰¾åˆ°ï¼š${{ env.HTML_OUTPUT }}"
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi

          # éªŒè¯CSVç¼“å­˜ï¼ˆCACHE_DIRä¸‹ï¼‰
          csv_path="${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}"
          if [ -f "$csv_path" ]; then
            csv_size=$(du -h "$csv_path" | cut -f1)
            echo "[SUCCESS] CSVç¼“å­˜å­˜åœ¨ - å¤§å°ï¼š$csv_size"
            echo "csv_exists=true" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] CSVç¼“å­˜æœªæ‰¾åˆ°ï¼š$csv_path"
            echo "csv_exists=false" >> $GITHUB_OUTPUT
          fi

          # åˆ—å‡ºå…³é”®æ–‡ä»¶ï¼ˆè°ƒè¯•æ¨¡å¼å¿…çœ‹ï¼‰
          if ${{ inputs.debug_mode }}; then
            echo "[DEBUG] æ ¹ç›®å½•æ–‡ä»¶ï¼š"
            ls -la .
            echo "[DEBUG] ç¼“å­˜ç›®å½•æ–‡ä»¶ï¼š"
            ls -la ${{ env.CACHE_DIR }}
          fi

      # 7. ä¸Šä¼ HTMLå›¾è¡¨ï¼ˆä»…å½“ç”ŸæˆæˆåŠŸæ—¶ï¼‰
      - name: Upload HTML Artifact
        if: steps.verify.outputs.html_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_ARTIFACT_PREFIX }}-chart
          path: ${{ env.HTML_OUTPUT }}
          retention-days: 7
          compression-level: 0

      # 8. ä¸Šä¼ CSVæ•°æ®ï¼ˆä»…å½“ç”ŸæˆæˆåŠŸæ—¶ï¼‰
      - name: Upload CSV Artifact
        if: steps.verify.outputs.csv_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_ARTIFACT_PREFIX }}-data
          path: ${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}
          retention-days: 7
          compression-level: 0

      # 9. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
      - name: Upload Log Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_ARTIFACT_PREFIX }}-logs
          path: |
            *.log
            ${{ env.CACHE_DIR }}/*.log
          retention-days: 3
          if-no-files-found: ignore

      # 10. å‘é€é€šçŸ¥ï¼ˆæ ¹æ®çŠ¶æ€ï¼‰
      - name: Success Notification
        if: success() && steps.verify.outputs.html_exists == 'true'
        run: |
          echo "ğŸ‰ å›¾è¡¨ç”ŸæˆæˆåŠŸï¼"
          echo "ğŸ“Š è®¿é—®å·¥ä»¶ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“ æ–‡ä»¶ï¼š${{ env.HTML_OUTPUT }}ï¼ˆå›¾è¡¨ï¼‰ã€${{ env.CACHE_DIR }}/${{ env.CSV_OUTPUT }}ï¼ˆæ•°æ®ï¼‰"

      - name: Partial Success Notification
        if: success() && steps.verify.outputs.html_exists != 'true'
        run: |
          echo "âš ï¸ è„šæœ¬è¿è¡Œä½†æœªç”Ÿæˆå›¾è¡¨"
          echo "ğŸ” è¯·æ£€æŸ¥æ—¥å¿—æˆ–CSVç¼“å­˜ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Failure Notification
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµå¤±è´¥ï¼"
          echo "ğŸ“ æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ env.WORKFLOW_ARTIFACT_PREFIX }}-logs"


  # å¯é€‰ï¼šæµ‹è¯•ä»»åŠ¡ï¼ˆéªŒè¯å·¥ä»¶å®Œæ•´æ€§ï¼‰
  test-artifacts:
    name: Test Generated Artifacts
    runs-on: ubuntu-latest
    needs: generate-chart
    if: always()  # å³ä½¿ä¸»ä»»åŠ¡å¤±è´¥ä¹Ÿè¿è¡Œ
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Verify Artifacts
        run: |
          echo "[INFO] ä¸‹è½½çš„å·¥ä»¶ï¼š"
          ls -la test-results
          echo "[SUCCESS] å·¥ä»¶ä¸‹è½½å®Œæˆ"
