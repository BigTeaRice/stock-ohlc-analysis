name: Generate Stock OHLC Charts

on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè°ƒè¯•+æŒ‡å®šè‚¡ç¥¨ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰"
        required: false
        default: false
        type: boolean
      tickers:
        description: "æŒ‡å®šè‚¡ç¥¨ä»£ç ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚0700.HK,0005.HKï¼‰"
        required: false
        default: "0700.HK"
        type: string
  
  # 2. å®šæ—¶ä»»åŠ¡ï¼šé¦™æ¸¯æ—¶é—´æ¯æ™š10ç‚¹ï¼ˆUTC14:00ï¼Œå‘¨ä¸€è‡³å‘¨äº”ï¼‰
  schedule:
    - cron: "0 14 * * 1-5"
  
  # 3. ä»£ç å˜æ›´è§¦å‘ï¼ˆmainåˆ†æ”¯/PRï¼‰
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ------------------------------
# å…¨å±€é…ç½®ï¼ˆå«å”¯ä¸€è¿è¡ŒIDï¼Œé¿å…å·¥ä»¶è¦†ç›–ï¼‰
# ------------------------------
env:
  PYTHON_VERSION: "3.10"
  BASE_CACHE_DIR: "stock_data"
  WORKFLOW_PREFIX: "stock-charts-${{ github.run_id }}"  # å”¯ä¸€æ ‡è¯†ï¼Œé¿å…ä¸åŒè¿è¡Œå·¥ä»¶é‡å
  REQUIREMENTS_FILE: "requirements.txt"
  LOG_RETENTION_DAYS: 3

jobs:
  # ------------------------------
  # é…ç½®å‡†å¤‡ä»»åŠ¡ï¼ˆè¾“å‡ºè‚¡ç¥¨åˆ—è¡¨+è°ƒè¯•æ¨¡å¼ï¼‰
  # ------------------------------
  setup-config:
    name: Setup Configuration
    runs-on: ubuntu-latest
    outputs:
      tickers: ${{ steps.setup.outputs.tickers }}
      debug_mode: ${{ steps.setup.outputs.debug_mode }}
      run_id: ${{ github.run_id }}  # ä¼ é€’è¿è¡ŒIDç»™åç»­ä»»åŠ¡
    steps:
      - name: Setup Tickers and Debug Mode
        id: setup
        run: |
          # å¤„ç†è‚¡ç¥¨ä»£ç ï¼ˆè¾“å…¥ä¼˜å…ˆï¼Œå¦åˆ™ç”¨é»˜è®¤ï¼‰
          if [[ -n "${{ github.event.inputs.tickers }}" ]]; then
            TICKERS="${{ github.event.inputs.tickers }}"
          else
            TICKERS="0700.HK"
          fi
          
          # è½¬æ¢ä¸ºJSONæ•°ç»„ï¼ˆå…¼å®¹çŸ©é˜µç­–ç•¥ï¼‰
          TICKER_JSON=$(echo "$TICKERS" | tr ',' '
' | jq -R . | jq -s .)
          echo "tickers=$TICKER_JSON" >> $GITHUB_OUTPUT
          
          # å¤„ç†è°ƒè¯•æ¨¡å¼ï¼ˆç©ºå€¼é»˜è®¤falseï¼‰
          DEBUG_MODE="${{ github.event.inputs.debug_mode }}"
          [[ -z "$DEBUG_MODE" ]] && DEBUG_MODE="false"
          echo "debug_mode=$DEBUG_MODE" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          
          echo "=== é…ç½®å®Œæˆ ==="
          echo "è‚¡ç¥¨ä»£ç : $TICKERS"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "è¿è¡ŒID: ${{ github.run_id }}"

  # ------------------------------
  # æ ¸å¿ƒä»»åŠ¡ï¼šç”Ÿæˆå›¾è¡¨ï¼ˆçŸ©é˜µç­–ç•¥ï¼ŒæŒ‰è‚¡ç¥¨å¹¶è¡Œï¼‰
  # ------------------------------
  generate-charts:
    name: "Generate Chart - ${{ matrix.ticker }}"
    runs-on: ubuntu-latest
    needs: setup-config  # ä¾èµ–é…ç½®ä»»åŠ¡
    timeout-minutes: 25
    strategy:
      matrix:
        ticker: ${{ fromJson(needs.setup-config.outputs.tickers) }}  # ä»é…ç½®ä»»åŠ¡è¯»å–è‚¡ç¥¨åˆ—è¡¨
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. è®¾ç½®Pythonç¯å¢ƒï¼ˆç¼“å­˜pipä¾èµ–ï¼‰
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–ï¼ˆä¼˜å…ˆç”¨requirements.txtï¼Œå¦åˆ™æ‰‹åŠ¨å®‰è£…ï¼‰
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [[ -f "${{ env.REQUIREMENTS_FILE }}" ]]; then
            pip install -r ${{ env.REQUIREMENTS_FILE }}
          else
            pip install pandas plotly yfinance pytz pydantic
          fi
          pip list | grep -E "pandas|plotly|yfinance|pytz|pydantic"  # éªŒè¯ä¾èµ–ç‰ˆæœ¬
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # 4. åˆ›å»ºæ•°æ®ç¼“å­˜ç›®å½•
      - name: Create Data Directory
        run: |
          mkdir -p ${{ env.BASE_CACHE_DIR }}
          echo "âœ… æ•°æ®ç›®å½•åˆ›å»ºå®Œæˆ: ${{ env.BASE_CACHE_DIR }}"

      # 5. è¿è¡Œç”Ÿæˆè„šæœ¬ï¼ˆä¼ é€’ç¯å¢ƒå˜é‡ï¼‰
      - name: Run Generation Script
        id: generate-script
        env:
          DEBUG_MODE: ${{ needs.setup-config.outputs.debug_mode }}
          TICKER: ${{ matrix.ticker }}
          CACHE_DIR: ${{ env.BASE_CACHE_DIR }}
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆè‚¡ç¥¨å›¾è¡¨ ==="
          echo "è‚¡ç¥¨ä»£ç : $TICKER | è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          
          # è®¾ç½®Pythonè„šæœ¬å¯ç”¨çš„ç¯å¢ƒå˜é‡
          export TICKER="$TICKER"
          export DEBUG_MODE="$DEBUG_MODE"
          export CACHE_DIR="$CACHE_DIR"
          
          # è¿è¡Œè„šæœ¬ï¼ˆå…è®¸å¤±è´¥ï¼Œåç»­éªŒè¯æ–‡ä»¶ï¼‰
          set +e
          python main.py
          EXIT_CODE=$?
          set -e  # æ¢å¤ä¸¥æ ¼æ¨¡å¼
          
          # è¾“å‡ºç»“æœ
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [[ $EXIT_CODE -eq 0 ]]; then
            echo "âœ… è‚¡ç¥¨ $TICKER å¤„ç†æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ è‚¡ç¥¨ $TICKER å¤„ç†å¤±è´¥ï¼ˆé€€å‡ºç : $EXIT_CODEï¼‰"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      # 6. éªŒè¯è¾“å‡ºæ–‡ä»¶ï¼ˆHTML/CSV/æ—¥å¿—ï¼‰
      - name: Verify Output Files
        id: verify-files
        run: |
          echo "=== éªŒè¯è¾“å‡ºæ–‡ä»¶ ==="
          HTML_FILE="${{ env.BASE_CACHE_DIR }}/ohlc_chart_${{ matrix.ticker }}.html"
          CSV_FILE="${{ env.BASE_CACHE_DIR }}/${{ matrix.ticker }}.csv"
          LOG_FILE="stock_chart.log"
          
          # éªŒè¯HTML
          if [[ -f "$HTML_FILE" ]]; then
            HTML_SIZE=$(ls -lh "$HTML_FILE" | awk '{print $5}')
            echo "âœ… HTMLæ–‡ä»¶å­˜åœ¨: $HTML_FILE (å¤§å°: $HTML_SIZE)"
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ HTMLæ–‡ä»¶ä¸å­˜åœ¨: $HTML_FILE"
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # éªŒè¯CSVï¼ˆè‡³å°‘æœ‰è¡¨å¤´+1è¡Œæ•°æ®ï¼‰
          if [[ -f "$CSV_FILE" ]]; then
            CSV_LINES=$(wc -l < "$CSV_FILE" 2>/dev/null || echo 0)
            if [[ $CSV_LINES -gt 1 ]]; then
              echo "âœ… CSVæ–‡ä»¶æœ‰æ•ˆ: $CSV_FILE (è¡Œæ•°: $CSV_LINES)"
              echo "csv_exists=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ CSVæ–‡ä»¶æ— æ•ˆï¼ˆè¡Œæ•°ä¸è¶³ï¼‰: $CSV_FILE"
              echo "csv_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ CSVæ–‡ä»¶ä¸å­˜åœ¨: $CSV_FILE"
            echo "csv_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # éªŒè¯æ—¥å¿—
          if [[ -f "$LOG_FILE" ]]; then
            LOG_SIZE=$(ls -lh "$LOG_FILE" | awk '{print $5}')
            echo "âœ… æ—¥å¿—æ–‡ä»¶å­˜åœ¨: $LOG_FILE (å¤§å°: $LOG_SIZE)"
            echo "log_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
            echo "log_exists=false" >> $GITHUB_OUTPUT
          fi

      # 7. ä¸Šä¼ HTMLå›¾è¡¨ï¼ˆä»…æˆåŠŸæ—¶ï¼Œå¸¦å”¯ä¸€è¿è¡ŒIDï¼‰
      - name: Upload HTML Chart
        if: steps.verify-files.outputs.html_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-chart
          path: ${{ env.BASE_CACHE_DIR }}/ohlc_chart_${{ matrix.ticker }}.html
          retention-days: 7  # ä¿ç•™7å¤©

      # 8. ä¸Šä¼ CSVæ•°æ®ï¼ˆä»…æˆåŠŸæ—¶ï¼‰
      - name: Upload CSV Data
        if: steps.verify-files.outputs.csv_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-data
          path: ${{ env.BASE_CACHE_DIR }}/${{ matrix.ticker }}.csv
          retention-days: 7

      # 9. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶ï¼ˆä»…å­˜åœ¨æ—¶ï¼‰
      - name: Upload Log Files
        if: steps.verify-files.outputs.log_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-logs
          path: stock_chart.log
          retention-days: ${{ env.LOG_RETENTION_DAYS }}
          if-no-files-found: ignore

      # 10. ä¸Šä¼ å®Œæ•´æ•°æ®å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
      - name: Upload Full Backup
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-backup
          path: ${{ env.BASE_CACHE_DIR }}/
          retention-days: 3
          if-no-files-found: ignore

      # 11. å•ä»»åŠ¡çŠ¶æ€è¾“å‡º
      - name: Completion Status
        run: |
          echo "=== å•ä»»åŠ¡å®ŒæˆçŠ¶æ€ ==="
          echo "è‚¡ç¥¨ä»£ç : ${{ matrix.ticker }}"
          echo "é€€å‡ºç : ${{ steps.generate-script.outputs.exit_code }}"
          echo "HTML: ${{ steps.verify-files.outputs.html_exists }}"
          echo "CSV: ${{ steps.verify-files.outputs.csv_exists }}"
          if [[ ${{ steps.generate-script.outputs.exit_code }} -eq 0 ]]; then
            echo "ğŸ‰ ä»»åŠ¡æˆåŠŸ"
          else
            echo "âš ï¸ ä»»åŠ¡å¤±è´¥"
          fi

      # 12. ä¿å­˜çŸ©é˜µä»»åŠ¡ç»“æœï¼ˆè‚¡ç¥¨+çŠ¶æ€ï¼‰
      - name: Save Matrix Result
        run: |
          CLEAN_STATUS=$(echo "${{ steps.generate-script.outputs.status }}" | xargs)
          echo "${{ matrix.ticker }}:$CLEAN_STATUS" >> matrix_task_results.txt
          echo "ğŸ’¾ ç»“æœå·²ä¿å­˜: ${{ matrix.ticker }} â†’ $CLEAN_STATUS"

      # 13. ä¸Šä¼ çŸ©é˜µç»“æœï¼ˆä¾›æ±‡æ€»æŠ¥å‘Šä½¿ç”¨ï¼‰
      - name: Upload Matrix Results
        uses: actions/upload-artifact@v4
        with:
          name: matrix-task-results-${{ needs.setup-config.outputs.run_id }}
          path: matrix_task_results.txt
          retention-days: ${{ env.LOG_RETENTION_DAYS }}
          if-no-files-found: ignore

  # ------------------------------
  # æ±‡æ€»æŠ¥å‘Šï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½è¿è¡Œï¼‰
  # ------------------------------
  summary-report:
    name: Summary Report
    runs-on: ubuntu-latest
    needs: 
      - setup-config
      - generate-charts
    if: always()  # å³ä½¿å‰ç½®ä»»åŠ¡å¤±è´¥ä¹Ÿè¿è¡Œ
    steps:
      # 1. ä¸‹è½½çŸ©é˜µä»»åŠ¡ç»“æœ
      - name: Download Matrix Results
        uses: actions/download-artifact@v4
        with:
          name: matrix-task-results-${{ needs.setup-config.outputs.run_id }}

      # 2. è§£æçŸ©é˜µç»“æœï¼ˆç»Ÿè®¡æˆåŠŸ/å¤±è´¥ï¼‰
      - name: Parse Matrix Results
        id: parse-results
        run: |
          echo "ğŸ“Š è§£æçŸ©é˜µä»»åŠ¡ç»“æœ..."
          SUCCESS=0
          FAILURE=0
          UNKNOWN=0
          RESULT_FILE="matrix_task_results.txt"
          
          if [[ -f "$RESULT_FILE" ]]; then
            while IFS=':' read -r TICKER STATUS; do
              TICKER=$(echo "$TICKER" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              STATUS=$(echo "$STATUS" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr '[:upper:]' '[:lower:]')
              
              case "$STATUS" in
                success) 
                  echo "   - $TICKER: âœ… æˆåŠŸ"
                  ((SUCCESS++))
                  ;;
                failure)
                  echo "   - $TICKER: âŒ å¤±è´¥"
                  ((FAILURE++))
                  ;;
                *)
                  echo "   - $TICKER: âš ï¸ æœªçŸ¥çŠ¶æ€"
                  ((UNKNOWN++))
                  ;;
              esac
            done < "$RESULT_FILE"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç»“æœæ–‡ä»¶: $RESULT_FILE"
          fi
          
          # ç»Ÿè®¡å¹¶ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          TOTAL=$((SUCCESS + FAILURE + UNKNOWN))
          echo "ğŸ“ˆ çŠ¶æ€ç»Ÿè®¡: æˆåŠŸ $SUCCESS / å¤±è´¥ $FAILURE / æ€»è®¡ $TOTAL"
          echo "summary_success=$SUCCESS" >> $GITHUB_ENV
          echo "summary_failure=$FAILURE" >> $GITHUB_ENV
          echo "summary_total=$TOTAL" >> $GITHUB_ENV

      # 3. ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
      - name: Generate Summary Report
        run: |
          echo "ğŸ“Š === è‚¡ç¥¨å›¾è¡¨ç”Ÿæˆå·¥ä½œæµæ±‡æ€» ==="
          echo "ğŸ·ï¸ å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ”¢ è¿è¡ŒID: ${{ github.run_id }}"
          echo "âš¡ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          [[ "${{ github.event_name }}" == "schedule" ]] && \
            echo "ğŸ•’ è§¦å‘æ—¶é—´: æ¯æ—¥é¦™æ¸¯æ—¶é—´22:00 (UTC14:00)" || \
            echo "ğŸ•’ è§¦å‘æ—¶é—´: ${{ github.event.timestamp || 'æ‰‹åŠ¨è§¦å‘' }}"
          echo "ğŸ“ˆ ç›®æ ‡è‚¡ç¥¨: ${{ needs.setup-config.outputs.tickers }}"
          echo "ğŸ› è°ƒè¯•æ¨¡å¼: ${{ needs.setup-config.outputs.debug_mode }}"
          echo ""
          echo "ğŸ“‹ æ ¸å¿ƒä»»åŠ¡çŠ¶æ€:"
          echo "   - é…ç½®ä»»åŠ¡: ${{ needs.setup-config.result }} (è¿è¡ŒID: ${{ needs.setup-config.outputs.run_id }})"
          echo "   - å›¾è¡¨ç”Ÿæˆ: ${{ needs.generate-charts.result }} (å¤„ç†è‚¡ç¥¨: ${{ needs.generate-charts.strategy.matrix.ticker | join(', ') }})"
          echo ""
          echo "ğŸ“Š è‚¡ç¥¨å¤„ç†è¯¦æƒ…:"
          echo "   æˆåŠŸ: ${{ env.summary_success || 0 }}"
          echo "   å¤±è´¥: ${{ env.summary_failure || 0 }}"
          echo "   æ€»è®¡: ${{ env.summary_total || 0 }}"
          echo ""
          echo "ğŸ“ å·¥ä»¶ä¸‹è½½:"
          echo "   - HTMLå›¾è¡¨: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-chart"
          echo "   - CSVæ•°æ®: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-data"
          echo "   - è¿è¡Œæ—¥å¿—: ${{ env.WORKFLOW_PREFIX }}-${{ matrix.ticker }}-logs"
          echo ""
          echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæ¯•ï¼"
          echo "================================"

# ------------------------------
# å¹¶å‘æ§åˆ¶ï¼ˆåŒä¸€å·¥ä½œæµåŒä¸€åˆ†æ”¯å–æ¶ˆä¹‹å‰çš„è¿è¡Œï¼‰
# ------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
