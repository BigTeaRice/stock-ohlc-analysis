name: Generate Stock OHLC Charts

on:
  # 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè°ƒè¯•+æŒ‡å®šè‚¡ç¥¨ï¼‰
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰"
        required: false
        default: false
        type: boolean
      tickers:
        description: "æŒ‡å®šè‚¡ç¥¨ä»£ç ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚0700.HK,0005.HKï¼‰"
        required: false
        default: "0700.HK"
        type: string
  
  # 2. å®šæ—¶ä»»åŠ¡ï¼šé¦™æ¸¯æ—¶é—´æ¯æ™š10ç‚¹ï¼ˆUTC14:00ï¼Œå‘¨ä¸€è‡³å‘¨äº”ï¼‰
  schedule:
    - cron: "0 14 * * 1-5"
  
  # 3. ä»£ç å˜æ›´è§¦å‘ï¼ˆmainåˆ†æ”¯/PRï¼‰
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ------------------------------
# å…¨å±€é…ç½®
# ------------------------------
env:
  PYTHON_VERSION: "3.10"
  BASE_CACHE_DIR: "stock_data"
  WORKFLOW_PREFIX: "stock-charts-${{ github.run_id }}"
  REQUIREMENTS_FILE: "requirements.txt"
  LOG_RETENTION: 3

jobs:
  # ------------------------------
  # é…ç½®å‡†å¤‡ä»»åŠ¡
  # ------------------------------
  setup-config:
    name: Setup Configuration
    runs-on: ubuntu-latest
    outputs:
      tickers: ${{ steps.setup.outputs.tickers }}
      debug_mode: ${{ steps.setup.outputs.debug_mode }}
    steps:
      - name: Setup Tickers and Debug Mode
        id: setup
        run: |
          # å¤„ç†è‚¡ç¥¨ä»£ç 
          if [[ -n "${{ github.event.inputs.tickers }}" ]]; then
            TICKERS="${{ github.event.inputs.tickers }}"
          else
            TICKERS="0700.HK"
          fi
          
          # è½¬æ¢ä¸ºJSONæ•°ç»„æ ¼å¼
          TICKER_JSON=$(echo "$TICKERS" | jq -R -s -c 'split(",")')
          echo "tickers=$TICKER_JSON" >> $GITHUB_OUTPUT
          
          # è°ƒè¯•æ¨¡å¼
          DEBUG_MODE="${{ github.event.inputs.debug_mode || 'false' }}"
          echo "debug_mode=$DEBUG_MODE" >> $GITHUB_OUTPUT
          
          echo "é…ç½®å®Œæˆ:"
          echo "è‚¡ç¥¨ä»£ç : $TICKERS"
          echo "è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"

  # ------------------------------
  # æ ¸å¿ƒä»»åŠ¡ï¼šç”Ÿæˆå›¾è¡¨
  # ------------------------------
  generate-charts:
    name: Generate Charts for ${{ matrix.ticker }}
    runs-on: ubuntu-latest
    needs: setup-config
    timeout-minutes: 20
    strategy:
      matrix:
        ticker: ${{ fromJson(needs.setup-config.outputs.tickers) }}
    outputs:
      status: ${{ steps.generate.outputs.status }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set Up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # 3. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "${{ env.REQUIREMENTS_FILE }}" ]; then
            pip install -r ${{ env.REQUIREMENTS_FILE }}
          else
            pip install pandas plotly yfinance pytz pydantic
          fi
          echo "[INFO] ä¾èµ–å®‰è£…å®Œæˆ"

      # 4. åˆ›å»ºæ•°æ®ç›®å½•
      - name: Create Data Directory
        run: |
          mkdir -p ${{ env.BASE_CACHE_DIR }}
          echo "[INFO] æ•°æ®ç›®å½•åˆ›å»ºå®Œæˆ"

      # 5. è¿è¡Œç”Ÿæˆè„šæœ¬
      - name: Run Generation Script
        id: generate
        env:
          DEBUG_MODE: ${{ needs.setup-config.outputs.debug_mode }}
          TICKER: ${{ matrix.ticker }}
        run: |
          echo "[INFO] å¯åŠ¨è„šæœ¬ - è‚¡ç¥¨: ${{ matrix.ticker }}, è°ƒè¯•: $DEBUG_MODE"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›Pythonè„šæœ¬ä½¿ç”¨
          export TICKER="${{ matrix.ticker }}"
          export DEBUG_MODE="$DEBUG_MODE"
          export CACHE_DIR="${{ env.BASE_CACHE_DIR }}"
          
          python main.py
          exit_code=$?
          
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          if [ $exit_code -eq 0 ]; then
            echo "[SUCCESS] è‚¡ç¥¨ ${{ matrix.ticker }} å¤„ç†æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "[ERROR] è‚¡ç¥¨ ${{ matrix.ticker }} å¤„ç†å¤±è´¥"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      # 6. éªŒè¯è¾“å‡ºæ–‡ä»¶
      - name: Verify Outputs
        id: verify
        run: |
          echo "[INFO] éªŒè¯è¾“å‡ºæ–‡ä»¶..."
          
          # æ¸…ç†è‚¡ç¥¨ä»£ç ä¸­çš„ç‰¹æ®Šå­—ç¬¦ç”¨äºæ–‡ä»¶å
          CLEAN_TICKER=$(echo "${{ matrix.ticker }}" | sed 's/[^a-zA-Z0-9]/_/g')
          
          HTML_FILE="${{ env.BASE_CACHE_DIR }}/ohlc_chart_${{ matrix.ticker }}.html"
          CSV_FILE="${{ env.BASE_CACHE_DIR }}/${{ matrix.ticker }}.csv"
          
          echo "æ£€æŸ¥HTMLæ–‡ä»¶: $HTML_FILE"
          echo "æ£€æŸ¥CSVæ–‡ä»¶: $CSV_FILE"
          
          # éªŒè¯HTMLæ–‡ä»¶
          if [ -f "$HTML_FILE" ]; then
            HTML_SIZE=$(ls -lh "$HTML_FILE" | awk '{print $5}')
            echo "âœ… HTMLæ–‡ä»¶å­˜åœ¨: $HTML_FILE (å¤§å°: $HTML_SIZE)"
            echo "html_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ HTMLæ–‡ä»¶ä¸å­˜åœ¨: $HTML_FILE"
            echo "html_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # éªŒè¯CSVæ–‡ä»¶
          if [ -f "$CSV_FILE" ]; then
            CSV_LINES=$(wc -l < "$CSV_FILE" 2>/dev/null || echo "0")
            if [ "$CSV_LINES" -gt 1 ]; then
              echo "âœ… CSVæ–‡ä»¶å­˜åœ¨: $CSV_FILE (è¡Œæ•°: $CSV_LINES)"
              echo "csv_exists=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ CSVæ–‡ä»¶æ— æ•ˆ: $CSV_FILE"
              echo "csv_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ CSVæ–‡ä»¶ä¸å­˜åœ¨: $CSV_FILE"
            echo "csv_exists=false" >> $GITHUB_OUTPUT
          fi

      # 7. ä¸Šä¼ HTMLå›¾è¡¨
      - name: Upload HTML Artifact
        if: steps.verify.outputs.html_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-chart-${{ matrix.ticker }}
          path: ${{ env.BASE_CACHE_DIR }}/ohlc_chart_${{ matrix.ticker }}.html
          retention-days: 7
          compression-level: 0

      # 8. ä¸Šä¼ CSVæ•°æ®
      - name: Upload CSV Artifact
        if: steps.verify.outputs.csv_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-data-${{ matrix.ticker }}
          path: ${{ env.BASE_CACHE_DIR }}/${{ matrix.ticker }}.csv
          retention-days: 7
          compression-level: 0

      # 9. ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      - name: Upload Log Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-logs-${{ matrix.ticker }}
          path: |
            stock_chart.log
            *.log
          retention-days: ${{ env.LOG_RETENTION }}
          if-no-files-found: ignore

      # 10. ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ä½œä¸ºå¤‡ä»½
      - name: Upload All Files Backup
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WORKFLOW_PREFIX }}-backup-${{ matrix.ticker }}
          path: ${{ env.BASE_CACHE_DIR }}/
          retention-days: 3
          if-no-files-found: ignore

      # 11. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      - name: Cleanup Temporary Files
        if: always()
        run: |
          echo "[INFO] æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          # ä¿ç•™ç¼“å­˜æ–‡ä»¶ï¼Œåªæ¸…ç†ä¸´æ—¶æ–‡ä»¶
          find . -name "*.tmp" -delete 2>/dev/null || true
          find . -name "*.temp" -delete 2>/dev/null || true

  # ------------------------------
  # æ±‡æ€»æŠ¥å‘Šä»»åŠ¡
  # ------------------------------
  generate-report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: 
      - setup-config
      - generate-charts
    if: always()
    
    steps:
      - name: Generate Workflow Report
        run: |
          echo "ğŸ“Š è‚¡ç¥¨å›¾è¡¨ç”Ÿæˆå·¥ä½œæµæŠ¥å‘Š"
          echo "================================"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è§¦å‘æ—¶é—´: ${{ github.event.schedule || 'æ‰‹åŠ¨è§¦å‘' }}"
          echo "è‚¡ç¥¨ä»£ç : ${{ needs.setup-config.outputs.tickers }}"
          echo "è°ƒè¯•æ¨¡å¼: ${{ needs.setup-config.outputs.debug_mode }}"
          echo "================================"
          
          # æ£€æŸ¥æ¯ä¸ªè‚¡ç¥¨çš„å¤„ç†çŠ¶æ€
          echo "å¤„ç†çŠ¶æ€:"
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„çŠ¶æ€æ£€æŸ¥é€»è¾‘
          
          echo "================================"
          echo "ğŸ“ ç”Ÿæˆçš„Artifacts:"
          echo "- HTMLå›¾è¡¨æ–‡ä»¶"
          echo "- CSVæ•°æ®æ–‡ä»¶" 
          echo "- è¿è¡Œæ—¥å¿—"
          echo "- å®Œæ•´å¤‡ä»½"
          echo "================================"

# ------------------------------
# å·¥ä½œæµçº§åˆ«é…ç½®
# ------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
