# ------------------------------
# GitHub Actions å·¥ä½œæµç¨‹ï¼šè‚¡ç¥¨æ•°æ®åˆ†æ
# ------------------------------
name: Stock Data Analysis Pipeline

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»£ç åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
on:
  push:
    branches: [ "main" ]

# å®šä¹‰ä½œæ¥­ï¼šåœ¨ Ubuntu æœ€æ–°ç¯å¢ƒä¸­è¿è¡Œ
jobs:
  analyze-and-upload:
    runs-on: ubuntu-latest
    # å®šä¹‰å·¥ä»¶åç§°å˜é‡ï¼ˆåŠ¨æ€ï¼ŒåŸºäºè¿è¡ŒIDï¼‰
    outputs:
      artifact-name: ${{ steps.set-artifact-name.outputs.artifact-name }}

    steps:
      # ------------------------------
      # æ­¥éª¤1ï¼šæª¢å‡ºå€‰åº«ä»£ç¢¼
      # ------------------------------
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------
      # æ­¥éª¤2ï¼šè®¾ç½® Python ç¯å¢ƒ
      # ------------------------------
      - name: Set Up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------
      # æ­¥éª¤3ï¼šå®‰è£…é¡¹ç›®ä¾èµ–
      # ------------------------------
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ------------------------------
      # æ­¥éª¤4ï¼šè¿è¡Œä¸»åˆ†æè„šæœ¬
      # ------------------------------
      - name: Run Main Script
        id: run-main
        run: |
          python main.py

      # ------------------------------
      # æ­¥éª¤5ï¼šè®¾ç½®å·¥ä»¶åç§°ï¼ˆåŠ¨æ€ï¼‰
      # ------------------------------
      - name: Set Artifact Name
        id: set-artifact-name
        run: |
          echo "artifact-name=stock-analysis-${{ github.run_id }}" >> $GITHUB_OUTPUT

      # ------------------------------
      # æ­¥éª¤6ï¼šä¸Šä¼ åˆ†æç»“æœï¼ˆå·¥ä»¶ï¼‰
      # ------------------------------
      - name: Upload Results as Artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set-artifact-name.outputs.artifact-name }}  # ä½¿ç”¨åŠ¨æ€åç§°
          path: |
            ohlc_chart.html
            data/*.csv
          retention-days: 7
          if-no-files-found: error

  download-and-verify:
    runs-on: ubuntu-latest
    # ä¾èµ– analyze-and-upload ä½œä¸šå®Œæˆ
    needs: analyze-and-upload
    steps:
      # ------------------------------
      # æ­¥éª¤1ï¼šè·å–ä¸Šä¼ çš„å·¥ä»¶åç§°
      # ------------------------------
      - name: Get Uploaded Artifact Name
        id: get-artifact-name
        run: |
          echo "artifact-name=${{ needs.analyze-and-upload.outputs.artifact-name }}" >> $GITHUB_OUTPUT

      # ------------------------------
      # æ­¥éª¤2ï¼šä¸‹è½½å·¥ä»¶
      # ------------------------------
      - name: Download Generated Files
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.get-artifact-name.outputs.artifact-name }}  # ä¸ä¸Šä¼ åç§°ä¸€è‡´
          path: ./downloaded-results

      # ------------------------------
      # æ­¥éª¤3ï¼šéªŒè¯ä¸‹è½½çš„æ–‡ä»¶
      # ------------------------------
      - name: Verify Downloaded Files
        run: |
          echo "âœ… ä¸‹è½½çš„å·¥ä»¶åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š"
          ls -l ./downloaded-results
          echo "ğŸ“Š æ£€æŸ¥ ohlc_chart.html æ˜¯å¦å­˜åœ¨ï¼š"
          test -f ./downloaded-results/ohlc_chart.html && echo "å­˜åœ¨" || echo "ä¸å­˜åœ¨"
